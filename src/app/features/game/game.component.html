<!-- Layout: Stack (Vertical) -->
<pb-layout type="stack" gap="none" class="game-root">

	<!-- 1. Header (Sticky) -->
	<pb-global-header title="Pokémon Bartle" variant="sticky">
		<div actions class="header-actions">

			<!-- Sound Switch with Label -->
			<div class="sound-switch-group">
				<span class="sound-label" [style.opacity]="audioService.soundEnabled() ? '1' : '0.5'">Sound</span>
				<pb-switch size="sm" [checked]="audioService.soundEnabled()"
					(checkedChange)="audioService.setSoundEnabled($event)">
				</pb-switch>
			</div>

			<pb-icon-button icon="help-circle" label="Help" (action)="toggleHelp()"></pb-icon-button>
			<pb-icon-button icon="settings" label="Settings" (action)="toggleSettings()"></pb-icon-button>
		</div>
	</pb-global-header>

	<!-- Main Content -->
	<div class="game-content">

		<!-- 2. History Area -->
		<div class="history-area">
			<!-- Grid Flow Column for Vertical First Filling -->
			<div class="history-grid">
				@for (item of history; track $index) {
				@if (item) {
				<pb-card type="compact-row" padding="auto">
					<!-- Container with relative positioning -->
					<div class="history-item-content">
						<!-- Left: Mode Icon -->
						<div class="history-mode-icon">
							<div>
								{{ item.mode === 'attack' ? '⚔️' : '❓' }}
							</div>
						</div>

						<!-- Left: Type chips (absolutely positioned, right-aligned from center) -->
						@if (item.type.includes('/')) {
						<!-- Dual Type: Type 1 at 22%, Type 2 at 8% -->
						<pb-label-chip class="history-chip-1" [type]="getSplitTypes(item.type)[0]" [iconOnly]="true"
							[label]="getTypeLabel(getSplitTypes(item.type)[0])" size="s"></pb-label-chip>
						<pb-label-chip class="history-chip-2" [type]="getSplitTypes(item.type)[1]" [iconOnly]="true"
							[label]="getTypeLabel(getSplitTypes(item.type)[1])" size="s"></pb-label-chip>
						} @else {
						<!-- Single Type: positioned at 22% -->
						<pb-label-chip class="history-chip-1" [type]="item.type" [iconOnly]="true"
							[label]="getTypeLabel(item.type)" size="s"></pb-label-chip>
						}

						<!-- Center: Divider Arrow -->
						<div class="history-divider">
							<pb-icon name="chevron-right" size="sm"></pb-icon>
						</div>

						<!-- Right: Outcome at 16% from center -->
						<div class="history-outcome">
							@if (item.mode === 'solve') {
							<!-- Solve Outcomes -->
							<span>{{ item.outcome }}</span>
							} @else {
							<!-- Attack Outcomes -->
							@if (item.outcome === 'critical') {
							<span>⭕</span>
							}
							@else if (item.outcome === 'effective') {
							<span>⭕</span>
							}
							@else if (item.outcome === 'neutral') { <span class="text-neutral">⚪</span> }
							@else if (item.outcome === 'resisted') { <span>🔺</span> }
							@else if (item.outcome === 'immune') { <span>✖</span> }
							}
						</div>
					</div>
				</pb-card>
				} @else {
				<!-- Standard Empty State: Standard Card with Placeholders -->
				<pb-card type="compact-row" padding="auto" background="white">
					<!-- Container with relative positioning -->
					<div class="history-item-content">
						<!-- Center: Divider Arrow (visible) -->
						<div class="history-empty-divider">
							<pb-icon name="chevron-right" size="sm"></pb-icon>
						</div>
					</div>
				</pb-card>
				}
				}
			</div>
		</div>

		<!-- 3. Control Area -->
		<div class="control-area">

			<!-- Staging Area (Preview) -->
			<!-- Using customClass to match history card height and styles exact, but with staging background -->
			<pb-card type="select-type" background="gray" class="transition-colors duration-300"
				[style.background-color]="stagingBackgroundColor()">
				<!-- Container with relative positioning -->
				<div class="staging-content">
					<!-- Left: Mode Icon -->
					<div class="staging-mode-icon">
						<div>
							{{ mode() === 'attack' ? '⚔️' : '❓' }}
						</div>
					</div>

					<!-- Left: Type chips -->
					@if (selectedType2(); as t2) {
					<div class="staging-chip-2">
						<pb-label-chip [type]="t2" [iconOnly]="true" [label]="typeLabels[t2]" size="s"></pb-label-chip>
					</div>
					}

					@if (selectedType1(); as t1) {
					<div class="staging-chip-1">
						<pb-label-chip [type]="t1" [iconOnly]="true" [label]="typeLabels[t1]" size="s"></pb-label-chip>
					</div>
					}

					<!-- Center: SELECT TYPE text (when empty) -->
					@if (!selectedType1() && !selectedType2()) {
					<span class="staging-placeholder">
						SELECT TYPE
					</span>
					}

					<!-- Center: Divider Arrow (when selected) -->
					@if (selectedType1() || selectedType2()) {
					<div class="staging-arrow">
						<pb-icon name="chevron-right" size="sm"></pb-icon>
					</div>
					}

					<!-- Right of Arrow: Outcome Icon (when outcome available) -->
					@if (stagingOutcome(); as outcome) {
					<div class="staging-outcome">
						<span>
							@if (mode() === 'solve') {
							<!-- Solve mode: 🟩/🟨/⬛ -->
							@if (outcome === 'perfect') { 🟩 }
							@else if (outcome === 'partial') { 🟨 }
							@else { ⬛ }
							} @else {
							<!-- Attack mode -->
							@if (difficulty() === 'pichu' && stagingMultiplier() !== null) {
							<!-- Easy mode: Show multiplier -->
							@if (stagingMultiplier() === 4) { ×4 }
							@else if (stagingMultiplier() === 2) { ×2 }
							@else if (stagingMultiplier() === 1) { ×1 }
							@else if (stagingMultiplier() === 0.5) { ×0.5 }
							@else if (stagingMultiplier() === 0.25) { ×0.25 }
							@else if (stagingMultiplier() === 0) { ×0 }
							} @else {
							<!-- Normal/Master mode: Show icons ⭕/⚪/🔺/✖ -->
							@if (outcome === 'critical') { ⭕ }
							@else if (outcome === 'effective') { ⭕ }
							@else if (outcome === 'neutral') { ⚪ }
							@else if (outcome === 'resisted') { 🔺 }
							@else if (outcome === 'immune') { ✖ }
							}
							}
						</span>
					</div>
					}

					<!-- Right: Outcome placeholder -->
					<div class="text-right min-w-[24px]"></div>
				</div>
			</pb-card>

			<!-- Type Keyboard (Flex Wrap) -->
			<div class="type-keyboard">
				@for (t of types; track t) {
				<button pb-action-chip [type]="t" [attr.data-pokemon-type]="t" [label]="typeLabels[t]" size="s"
					class="type-chip" [class.selected]="selectedType1() === t || selectedType2() === t"
					[class.pointer-events-none]="isShowingFeedback()" (action)="selectType(t)">
				</button>
				}
			</div>

			<!-- Action Row -->
			<div class="action-row">
				<!-- Mode Selectors -->
				<div class="mode-selector">
					<button class="mode-button" [class.active]="mode() === 'attack'"
						[class.inactive]="mode() !== 'attack'" (click)="setMode('attack')">
						<span>⚔️</span>
						<span>Attack</span>
					</button>
					<button class="mode-button" [class.active]="mode() === 'solve'"
						[class.inactive]="mode() !== 'solve'" (click)="setMode('solve')">
						<span>❓</span>
						<span>Solve</span>
					</button>
				</div>

				<!-- Submit Button -->
				<button pb-button color="primary" [disabled]="!selectedType1()" (click)="submitAction()"
					class="submit-button">
					決定
				</button>
			</div>
		</div>

		<!-- 4. Auto-Memo & Manual Memo Area -->
		<pb-card type="default" background="white" [borderThick]="true" padding="sm">
			<div class="memo-container">
				<!-- Top: Validation History lines -->
				<div class="memo-section history-section">
					<h3 class="memo-section-title">History</h3>

					<!-- Critical/Effective -->
					<div class="history-row">
						<div class="history-content">
							<div class="history-emoji">⭕</div>
							<div class="history-chips">
								@for (t of memoData.critical; track t) {
								<pb-label-chip [type]="t" [iconOnly]="true" size="s"></pb-label-chip>
								}
								@for (t of memoData.effective; track t) {
								<pb-label-chip [type]="t" [iconOnly]="true" size="s"></pb-label-chip>
								}
							</div>
						</div>
						<div class="history-separator"></div>
					</div>
					<!-- Neutral -->
					<div class="history-row">
						<div class="history-content">
							<div class="history-emoji">⚪</div>
							<div class="history-chips">
								@for (t of memoData.neutral; track t) {
								<pb-label-chip [type]="t" [iconOnly]="true" size="s"></pb-label-chip>
								}
							</div>
						</div>
						<div class="history-separator"></div>
					</div>
					<!-- Resisted -->
					<div class="history-row">
						<div class="history-content">
							<div class="history-emoji">🔺</div>
							<div class="history-chips">
								@for (t of memoData.resisted; track t) {
								<pb-label-chip [type]="t" [iconOnly]="true" size="s"></pb-label-chip>
								}
							</div>
						</div>
						<div class="history-separator"></div>
					</div>
					<!-- Immune -->
					<div class="history-row">
						<div class="history-content">
							<div class="history-emoji">✖</div>
							<div class="history-chips">
								@for (t of memoData.immune; track t) {
								<pb-label-chip [type]="t" [iconOnly]="true" size="s"></pb-label-chip>
								}
							</div>
						</div>
						<div class="history-separator"></div>
					</div>
				</div>

				<!-- Bottom: Manual Memo Chips -->
				<div class="memo-section">
					<h3 class="memo-section-title">Memo</h3>
					<div class="memo-grid">
						@for (t of types; track t) {
						<div class="memo-item">
							<button pb-action-chip [type]="t" [iconOnly]="true" [label]="typeLabels[t]" size="s"
								class="memo-chip" (action)="toggleChipState(t)">
							</button>

							<!-- Overlay Icon -->
							@if (chipStates[t] === 'cross') {
							<div class="memo-overlay">
								<img src="assets/icons/ui/x.svg" alt="Cross mark" class="memo-overlay-icon">
							</div>
							} @else if (chipStates[t] === 'circle') {
							<div class="memo-overlay">
								<img src="assets/icons/ui/circle.svg" alt="Circle mark" class="memo-overlay-icon">
							</div>
							}
						</div>
						}
					</div>
				</div>
			</div>
		</pb-card>

	</div>


</pb-layout>

<!-- Dialogs -->
<pb-modal [isOpen]="isHelpOpen()" title="How to Play" (close)="toggleHelp()">
	<div class="modal-content">
		<h3 class="modal-title">How To Play</h3>
		<p class="modal-text">ポケモンの「タイプ」を当てる論理パズルゲームです、攻撃して相性を確かめ、正解のタイプを特定しましょう。</p>

		<h4 class="section-header">判定方法</h4>
		<section class="help-section">
			<div>
				<div class="help-example">
					<span>e.g.)⚔️Attack</span>
					<pb-label-chip type="water" label="みず" size="s"></pb-label-chip>
				</div>
				<div class="help-example-desc">
					<strong>結果：⭕（こうかは　ばつぐんだ！）</strong><br>
					<strong>意味：</strong> 相手は「みず」タイプがのわざが弱点のようです。
				</div>
				<div class="help-callout">
					<div><strong>⭕（こうかは　ばつぐんだ！）</strong>: ダメージ2倍以上です。</div>
					<div><strong>⚪（等倍、なにもなし）</strong>: ダメージは1倍です。</div>
					<div><strong>🔺（こうかは　いまひとつだ）</strong>: ダメージは半減以下です。</div>
					<div><strong>✖（こうかは　ないようだ...）</strong>: ダメージはゼロです。</div>
				</div>
			</div>
			<br>
			<div>
				<div class="help-example">
					<span>e.g.)❓Solve</span>
					<div class="result-chips">
						<pb-label-chip type="dragon" label="ドラゴン" size="s"></pb-label-chip>
						<pb-label-chip type="fairy" label="フェアリー" size="s"></pb-label-chip>
					</div>
				</div>
				<div class="help-example-desc">
					<strong>結果：🟨 (Close)</strong><br>
					<strong>意味：</strong>相手は「ドラゴン」か「フェアリー」の片方だけを持ってます。
				</div>
				<div class="help-callout">
					<div><strong>🟩 (Correct)</strong>: すべてのタイプが一致しました。クリアです🎉</div>
					<div><strong>🟨 (Close)</strong>: ひとつのタイプだけあってます。</div>
					<div><strong>⬛ (Miss)</strong>: 選んだタイプは含まれません。</div>
				</div>
			</div>
		</section>

		<h4 class="section-header section-header-mt">補足ルール</h4>
		<ul class="help-list">
			<li>正解は「単タイプ」また「複合タイプ」全171通りから選ばれます。</li>
			<li>複合タイプの順番は関係ありません。入れ替えても同じ扱いです。</li>
			<li>「ふゆう」「ちくでん」などの特性や、「ひかりのこな」などの持ち物による効果は考慮しません。</li>
			<li>最新の第9世代の相性表に基づいています。</li>
			<li>実際のポケモンにはいない複合タイプが出題されることもあります。</li>
			<li>ふつうの難易度のNORMALモードのほかに、やさしめなEASYモードと、むずかしめなMASTERモードがあります。</li>
		</ul>

		<div class="help-callout">
			<div class="section-header">難易度による違い</div>
			<p>
				<strong>NORMALモード</strong>：10回までに正解を当てることがクリアの条件になります。<br>
				<strong>MASTERモード</strong>：6回が回数上限になります。また、❓Solveで回答できるのがが1回きりになります。<br>
				<strong>EASYモード</strong>：⭕/⚪/🔺/✖による表示ではなく、攻撃が通る倍率（×4、×0.5など）が表示されます。また、カンニング用にいつでもタイプ相性表がみられます。
			</p>
		</div>

		<div class="help-footer">
			<p>©2025 Pokémon. ©1995-2025 Nintendo/Creatures Inc./GAME FREAK inc.</p>
			<p>本サイトでは、「Pokémon Game Sound Library」の利用規約に同意したうえで、当サイトで配布された音源を利用しています。</p>
			<p>当サイトは個人が運営するファンサイトであり、株式会社ポケモン様を始めとした公式団体とは一切関係ありません。</p>
		</div>
	</div>
</pb-modal>

<pb-modal [isOpen]="isSettingsOpen()" title="Settings" [showFooter]="true" (close)="cancelSettings()">
	<div class="modal-content">
		<h3 class="settings-section-title">Difficulty</h3>
		<div class="settings-options">
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'pichu'"
				(click)="tempDifficulty.set('pichu')">
				<div>
					<div class="difficulty-title">ピチュー級</div>
					<div class="difficulty-desc">Shows exact multipliers (x4, x2). Best for learning.</div>
				</div>
			</button>
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'arcanine'"
				(click)="tempDifficulty.set('arcanine')">
				<div>
					<div class="difficulty-title">ウインディ級</div>
					<div class="difficulty-desc">Standard rules. Hides multipliers. 10 Turns.</div>
				</div>
			</button>
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'garchomp'"
				(click)="tempDifficulty.set('garchomp')">
				<div>
					<div class="difficulty-title">ガブリアス級</div>
					<div class="difficulty-desc">Hardcore. 6 Turns. One-Shot Answer only.</div>
				</div>
			</button>
		</div>
	</div>

	<div footer class="modal-footer">
		<button pb-button color="secondary" pattern="filled" (click)="cancelSettings()">Cancel</button>
		<button pb-button color="primary" pattern="filled" (click)="applySettings()">Apply</button>
	</div>
</pb-modal>

<!-- Result Modal -->
<pb-modal [isOpen]="isGameOver()" [title]="gameResult() === 'win' ? 'WINNER!' : 'GAME OVER'" [showHeader]="false"
	(close)="startGame()">
	<div class="result-content">
		<!-- Header -->
		<div class="result-header" [class.win]="gameResult() === 'win'" [class.lose]="gameResult() === 'lose'">
			<div class="result-emoji">
				{{ gameResult() === 'win' ? '🎉' : '💀' }}
			</div>
			<h2 class="result-title" [class.win]="gameResult() === 'win'" [class.lose]="gameResult() === 'lose'">
				{{ gameResult() === 'win' ? 'YOU WIN!' : 'GAME OVER' }}
			</h2>
			<p class="result-subtitle">
				{{ gameResult() === 'win' ? 'Target Captured!' : 'Target Escaped...' }}
			</p>
		</div>

		<!-- Result Details -->
		<div class="result-details">
			<p class="result-label">TARGET WAS</p>
			<div class="result-chips">
				@for (t of target; track t) {
				<pb-label-chip [type]="t" [label]="typeLabels[t]" size="m"></pb-label-chip>
				}
			</div>
		</div>

		<!-- Actions -->
		<div class="result-actions">
			<button pb-button color="primary" pattern="filled" class="result-btn result-btn-primary"
				(click)="startGame()">
				PLAY AGAIN
			</button>
			<button pb-button color="secondary" pattern="outline" class="result-btn result-btn-secondary"
				(click)="shareResult()">
				<pb-icon name="file-copy" size="sm"></pb-icon>
				<span>Share Result</span>
			</button>
		</div>
	</div>

	<!-- Toast Notification (Moved inside modal to appear on top layer, using overlay slot to avoid transform context) -->
	@if (toastMessage()) {
	<pb-toast overlay [type]="toastType()" [message]="toastMessage()!" [duration]="3000" [dismissible]="false"
		(dismiss)="toastMessage.set(null)"></pb-toast>
	}
</pb-modal>