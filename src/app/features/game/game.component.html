<!-- Layout: Stack (Vertical) -->
<pb-layout type="stack" gap="none" class="game-root">

	<!-- 1. Header (Sticky) -->
	<pb-global-header title="PokÃ©mon Bartle" variant="sticky">
		<div actions class="header-actions">
			<!-- Status Indicators - Desktop only -->
			<div class="difficulty-indicator">
				<span class="difficulty-badge">{{ difficulty() }}</span>
			</div>

			<!-- Sound Switch with Label -->
			<div class="sound-switch-group">
				<span class="sound-label" [style.opacity]="audioService.soundEnabled() ? '1' : '0.5'">Sound</span>
				<pb-switch size="sm" [checked]="audioService.soundEnabled()"
					(checkedChange)="audioService.setSoundEnabled($event)">
				</pb-switch>
			</div>

			<pb-icon-button icon="help-circle" label="Help" (action)="toggleHelp()"></pb-icon-button>
			<pb-icon-button icon="settings" label="Settings" (action)="toggleSettings()"></pb-icon-button>
		</div>
	</pb-global-header>

	<!-- Mobile Status Bar -->
	<div class="mobile-status-bar">
		<span>{{ difficulty() }}</span>
	</div>

	<!-- Main Content -->
	<div class="game-content">

		<!-- 2. History Area -->
		<div class="history-area">
			<!-- Grid Flow Column for Vertical First Filling -->
			<div class="history-grid">
				@for (item of history; track $index) {
				@if (item) {
				<pb-card type="compact-row" padding="auto">
					<!-- Container with relative positioning -->
					<div class="history-item-content">
						<!-- Left: Mode Icon -->
						<div class="history-mode-icon">
							<div>
								{{ item.mode === 'attack' ? 'âš”ï¸' : 'â“' }}
							</div>
						</div>

						<!-- Left: Type chips (absolutely positioned, right-aligned from center) -->
						@if (item.type.includes('/')) {
						<!-- Dual Type: Type 1 at 22%, Type 2 at 8% -->
						<pb-label-chip class="history-chip-1" [type]="getSplitTypes(item.type)[0]" [iconOnly]="true"
							[label]="getTypeLabel(getSplitTypes(item.type)[0])" size="s"></pb-label-chip>
						<pb-label-chip class="history-chip-2" [type]="getSplitTypes(item.type)[1]" [iconOnly]="true"
							[label]="getTypeLabel(getSplitTypes(item.type)[1])" size="s"></pb-label-chip>
						} @else {
						<!-- Single Type: positioned at 22% -->
						<pb-label-chip class="history-chip-1" [type]="item.type" [iconOnly]="true"
							[label]="getTypeLabel(item.type)" size="s"></pb-label-chip>
						}

						<!-- Center: Divider Arrow -->
						<div class="history-divider">
							<pb-icon name="chevron-right" size="sm"></pb-icon>
						</div>

						<!-- Right: Outcome at 16% from center -->
						<div class="history-outcome">
							@if (item.mode === 'solve') {
							<!-- Solve Outcomes -->
							<span>{{ item.outcome }}</span>
							} @else {
							<!-- Attack Outcomes -->
							@if (item.outcome === 'critical') {
							<span>â­•</span>
							}
							@else if (item.outcome === 'effective') {
							<span>â­•</span>
							}
							@else if (item.outcome === 'neutral') { <span class="text-neutral">âšª</span> }
							@else if (item.outcome === 'resisted') { <span>ğŸ”º</span> }
							@else if (item.outcome === 'immune') { <span>âœ–</span> }
							}
						</div>
					</div>
				</pb-card>
				} @else {
				<!-- Standard Empty State: Standard Card with Placeholders -->
				<pb-card type="compact-row" padding="auto" background="white">
					<!-- Container with relative positioning -->
					<div class="history-item-content">
						<!-- Center: Divider Arrow (visible) -->
						<div class="history-empty-divider">
							<pb-icon name="chevron-right" size="sm"></pb-icon>
						</div>
					</div>
				</pb-card>
				}
				}
			</div>
		</div>

		<!-- 3. Control Area -->
		<div class="control-area">

			<!-- Staging Area (Preview) -->
			<!-- Using customClass to match history card height and styles exact, but with staging background -->
			<pb-card type="select-type" background="gray" class="transition-colors duration-300"
				[style.background-color]="stagingBackgroundColor()">
				<!-- Container with relative positioning -->
				<div class="staging-content">
					<!-- Left: Mode Icon -->
					<div class="staging-mode-icon">
						<div>
							{{ mode() === 'attack' ? 'âš”ï¸' : 'â“' }}
						</div>
					</div>

					<!-- Left: Type chips -->
					@if (selectedType2(); as t2) {
					<div class="staging-chip-2">
						<pb-label-chip [type]="t2" [iconOnly]="true" [label]="typeLabels[t2]" size="s"></pb-label-chip>
					</div>
					}

					@if (selectedType1(); as t1) {
					<div class="staging-chip-1">
						<pb-label-chip [type]="t1" [iconOnly]="true" [label]="typeLabels[t1]" size="s"></pb-label-chip>
					</div>
					}

					<!-- Center: SELECT TYPE text (when empty) -->
					@if (!selectedType1() && !selectedType2()) {
					<span class="staging-placeholder">
						SELECT TYPE
					</span>
					}

					<!-- Center: Divider Arrow (when selected) -->
					@if (selectedType1() || selectedType2()) {
					<div class="staging-arrow">
						<pb-icon name="chevron-right" size="sm"></pb-icon>
					</div>
					}

					<!-- Right of Arrow: Outcome Icon (when outcome available) -->
					@if (stagingOutcome(); as outcome) {
					<div class="staging-outcome">
						<span>
							@if (mode() === 'solve') {
							<!-- Solve mode: ğŸŸ©/ğŸŸ¨/â¬› -->
							@if (outcome === 'perfect') { ğŸŸ© }
							@else if (outcome === 'partial') { ğŸŸ¨ }
							@else { â¬› }
							} @else {
							<!-- Attack mode -->
							@if (difficulty() === 'easy' && stagingMultiplier() !== null) {
							<!-- Easy mode: Show multiplier -->
							@if (stagingMultiplier() === 4) { Ã—4 }
							@else if (stagingMultiplier() === 2) { Ã—2 }
							@else if (stagingMultiplier() === 1) { Ã—1 }
							@else if (stagingMultiplier() === 0.5) { Ã—0.5 }
							@else if (stagingMultiplier() === 0.25) { Ã—0.25 }
							@else if (stagingMultiplier() === 0) { Ã—0 }
							} @else {
							<!-- Normal/Master mode: Show icons â­•/âšª/ğŸ”º/âœ– -->
							@if (outcome === 'critical') { â­• }
							@else if (outcome === 'effective') { â­• }
							@else if (outcome === 'neutral') { âšª }
							@else if (outcome === 'resisted') { ğŸ”º }
							@else if (outcome === 'immune') { âœ– }
							}
							}
						</span>
					</div>
					}

					<!-- Right: Outcome placeholder -->
					<div class="text-right min-w-[24px]"></div>
				</div>
			</pb-card>

			<!-- Type Keyboard (Flex Wrap) -->
			<div class="type-keyboard">
				@for (t of types; track t) {
				<button pb-action-chip [type]="t" [attr.data-pokemon-type]="t" [label]="typeLabels[t]" size="s"
					class="type-chip" [class.selected]="selectedType1() === t || selectedType2() === t"
					[class.pointer-events-none]="isShowingFeedback()" (action)="selectType(t)">
				</button>
				}
			</div>

			<!-- Action Row -->
			<div class="action-row">
				<!-- Mode Selectors -->
				<div class="mode-selector">
					<button class="mode-button" [class.active]="mode() === 'attack'"
						[class.inactive]="mode() !== 'attack'" (click)="setMode('attack')">
						<span>âš”ï¸</span>
						<span>Attack</span>
					</button>
					<button class="mode-button" [class.active]="mode() === 'solve'"
						[class.inactive]="mode() !== 'solve'" (click)="setMode('solve')">
						<span>â“</span>
						<span>Solve</span>
					</button>
				</div>

				<!-- Submit Button -->
				<button pb-button color="primary" [disabled]="!selectedType1()" (click)="submitAction()"
					class="submit-button">
					æ±ºå®š
				</button>
			</div>
		</div>

		<!-- 4. Auto-Memo & Manual Memo Area -->
		<pb-card type="default" background="white" [borderThick]="true" padding="sm">
			<div class="memo-container">
				<!-- Top: Validation History lines -->
				<div class="memo-section history-section">
					<h3 class="memo-section-title">History</h3>

					<!-- Critical/Effective -->
					<div class="history-row">
						<div class="history-label">â­•</div>
						<div class="history-separator"></div>
						<div class="history-chips">
							@for (t of memoData.critical; track t) {
							<span class="mini-chip" [attr.data-type]="t"></span>
							}
							@for (t of memoData.effective; track t) {
							<span class="mini-chip" [attr.data-type]="t"></span>
							}
						</div>
					</div>
					<!-- Neutral -->
					<div class="history-row">
						<div class="history-label text-gray">âšª</div>
						<div class="history-separator"></div>
						<div class="history-chips">
							@for (t of memoData.neutral; track t) {
							<span class="mini-chip" [attr.data-type]="t"></span>
							}
						</div>
					</div>
					<!-- Resisted -->
					<div class="history-row">
						<div class="history-label">ğŸ”º</div>
						<div class="history-separator"></div>
						<div class="history-chips">
							@for (t of memoData.resisted; track t) {
							<span class="mini-chip" [attr.data-type]="t"></span>
							}
						</div>
					</div>
					<!-- Immune -->
					<div class="history-row">
						<div class="history-label">âœ–</div>
						<div class="history-separator"></div>
						<div class="history-chips">
							@for (t of memoData.immune; track t) {
							<span class="mini-chip" [attr.data-type]="t"></span>
							}
						</div>
					</div>
				</div>

				<!-- Bottom: Manual Memo Chips -->
				<div class="memo-section">
					<h3 class="memo-section-title">Memo</h3>
					<div class="memo-grid">
						@for (t of types; track t) {
						<div class="memo-item">
							<button pb-action-chip [type]="t" [iconOnly]="true" [label]="typeLabels[t]" size="s"
								class="memo-chip" (action)="toggleChipState(t)">
							</button>

							<!-- Overlay Icon -->
							@if (chipStates[t] === 'cross') {
							<div class="memo-overlay">
								<img src="assets/icons/ui/x.svg" alt="Cross mark" class="memo-overlay-icon">
							</div>
							} @else if (chipStates[t] === 'circle') {
							<div class="memo-overlay">
								<img src="assets/icons/ui/circle.svg" alt="Circle mark" class="memo-overlay-icon">
							</div>
							}
						</div>
						}
					</div>
				</div>
			</div>
		</pb-card>

	</div>


</pb-layout>

<!-- Dialogs -->
<pb-modal [isOpen]="isHelpOpen()" title="How to Play" (close)="toggleHelp()">
	<div class="modal-content">
		<h3 class="modal-title">How To Play</h3>
		<p class="modal-text">ãƒã‚±ãƒ¢ãƒ³ã®ã€Œã‚¿ã‚¤ãƒ—ã€ã‚’å½“ã¦ã‚‹è«–ç†ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ã§ã™ã€æ”»æ’ƒã—ã¦ç›¸æ€§ã‚’ç¢ºã‹ã‚ã€æ­£è§£ã®ã‚¿ã‚¤ãƒ—ã‚’ç‰¹å®šã—ã¾ã—ã‚‡ã†ã€‚</p>

		<h4 class="section-header">åˆ¤å®šæ–¹æ³•</h4>
		<section class="help-section">
			<div>
				<div class="help-example">
					<span>e.g.)âš”ï¸Attack</span>
					<pb-label-chip type="water" label="ã¿ãš" size="s"></pb-label-chip>
				</div>
				<div class="help-example-desc">
					<strong>çµæœï¼šâ­•ï¼ˆã“ã†ã‹ã¯ã€€ã°ã¤ãã‚“ã ï¼ï¼‰</strong><br>
					<strong>æ„å‘³ï¼š</strong> ç›¸æ‰‹ã¯ã€Œã¿ãšã€ã‚¿ã‚¤ãƒ—ãŒã®ã‚ã–ãŒå¼±ç‚¹ã®ã‚ˆã†ã§ã™ã€‚
				</div>
				<div class="help-callout">
					<div><strong>â­•ï¼ˆã“ã†ã‹ã¯ã€€ã°ã¤ãã‚“ã ï¼ï¼‰</strong>: ãƒ€ãƒ¡ãƒ¼ã‚¸2å€ä»¥ä¸Šã§ã™ã€‚</div>
					<div><strong>âšªï¼ˆç­‰å€ã€ãªã«ã‚‚ãªã—ï¼‰</strong>: ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯1å€ã§ã™ã€‚</div>
					<div><strong>ğŸ”ºï¼ˆã“ã†ã‹ã¯ã€€ã„ã¾ã²ã¨ã¤ã ï¼‰</strong>: ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯åŠæ¸›ä»¥ä¸‹ã§ã™ã€‚</div>
					<div><strong>âœ–ï¼ˆã“ã†ã‹ã¯ã€€ãªã„ã‚ˆã†ã ...ï¼‰</strong>: ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯ã‚¼ãƒ­ã§ã™ã€‚</div>
				</div>
			</div>
			<br>
			<div>
				<div class="help-example">
					<span>e.g.)â“Solve</span>
					<div class="result-chips">
						<pb-label-chip type="dragon" label="ãƒ‰ãƒ©ã‚´ãƒ³" size="s"></pb-label-chip>
						<pb-label-chip type="fairy" label="ãƒ•ã‚§ã‚¢ãƒªãƒ¼" size="s"></pb-label-chip>
					</div>
				</div>
				<div class="help-example-desc">
					<strong>çµæœï¼šğŸŸ¨ (Close)</strong><br>
					<strong>æ„å‘³ï¼š</strong>ç›¸æ‰‹ã¯ã€Œãƒ‰ãƒ©ã‚´ãƒ³ã€ã‹ã€Œãƒ•ã‚§ã‚¢ãƒªãƒ¼ã€ã®ç‰‡æ–¹ã ã‘ã‚’æŒã£ã¦ã¾ã™ã€‚
				</div>
				<div class="help-callout">
					<div><strong>ğŸŸ© (Correct)</strong>: ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚ã‚¯ãƒªã‚¢ã§ã™ğŸ‰</div>
					<div><strong>ğŸŸ¨ (Close)</strong>: ã²ã¨ã¤ã®ã‚¿ã‚¤ãƒ—ã ã‘ã‚ã£ã¦ã¾ã™ã€‚</div>
					<div><strong>â¬› (Miss)</strong>: é¸ã‚“ã ã‚¿ã‚¤ãƒ—ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚</div>
				</div>
			</div>
		</section>

		<h4 class="section-header section-header-mt">è£œè¶³ãƒ«ãƒ¼ãƒ«</h4>
		<ul class="help-list">
			<li>æ­£è§£ã¯ã€Œå˜ã‚¿ã‚¤ãƒ—ã€ã¾ãŸã€Œè¤‡åˆã‚¿ã‚¤ãƒ—ã€å…¨171é€šã‚Šã‹ã‚‰é¸ã°ã‚Œã¾ã™ã€‚</li>
			<li>è¤‡åˆã‚¿ã‚¤ãƒ—ã®é †ç•ªã¯é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚å…¥ã‚Œæ›¿ãˆã¦ã‚‚åŒã˜æ‰±ã„ã§ã™ã€‚</li>
			<li>ã€Œãµã‚†ã†ã€ã€Œã¡ãã§ã‚“ã€ãªã©ã®ç‰¹æ€§ã‚„ã€ã€Œã²ã‹ã‚Šã®ã“ãªã€ãªã©ã®æŒã¡ç‰©ã«ã‚ˆã‚‹åŠ¹æœã¯è€ƒæ…®ã—ã¾ã›ã‚“ã€‚</li>
			<li>æœ€æ–°ã®ç¬¬9ä¸–ä»£ã®ç›¸æ€§è¡¨ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚</li>
			<li>å®Ÿéš›ã®ãƒã‚±ãƒ¢ãƒ³ã«ã¯ã„ãªã„è¤‡åˆã‚¿ã‚¤ãƒ—ãŒå‡ºé¡Œã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚</li>
			<li>ãµã¤ã†ã®é›£æ˜“åº¦ã®NORMALãƒ¢ãƒ¼ãƒ‰ã®ã»ã‹ã«ã€ã‚„ã•ã—ã‚ãªEASYãƒ¢ãƒ¼ãƒ‰ã¨ã€ã‚€ãšã‹ã—ã‚ãªMASTERãƒ¢ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ã€‚</li>
		</ul>

		<div class="help-callout">
			<div class="section-header">é›£æ˜“åº¦ã«ã‚ˆã‚‹é•ã„</div>
			<p>
				<strong>NORMALãƒ¢ãƒ¼ãƒ‰</strong>ï¼š10å›ã¾ã§ã«æ­£è§£ã‚’å½“ã¦ã‚‹ã“ã¨ãŒã‚¯ãƒªã‚¢ã®æ¡ä»¶ã«ãªã‚Šã¾ã™ã€‚<br>
				<strong>MASTERãƒ¢ãƒ¼ãƒ‰</strong>ï¼š6å›ãŒå›æ•°ä¸Šé™ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€â“Solveã§å›ç­”ã§ãã‚‹ã®ãŒãŒ1å›ãã‚Šã«ãªã‚Šã¾ã™ã€‚<br>
				<strong>EASYãƒ¢ãƒ¼ãƒ‰</strong>ï¼šâ­•/âšª/ğŸ”º/âœ–ã«ã‚ˆã‚‹è¡¨ç¤ºã§ã¯ãªãã€æ”»æ’ƒãŒé€šã‚‹å€ç‡ï¼ˆÃ—4ã€Ã—0.5ãªã©ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¾ãŸã€ã‚«ãƒ³ãƒ‹ãƒ³ã‚°ç”¨ã«ã„ã¤ã§ã‚‚ã‚¿ã‚¤ãƒ—ç›¸æ€§è¡¨ãŒã¿ã‚‰ã‚Œã¾ã™ã€‚
			</p>
		</div>

		<div class="help-footer">
			<p>Â©2025 PokÃ©mon. Â©1995-2025 Nintendo/Creatures Inc./GAME FREAK inc.</p>
			<p>æœ¬ã‚µã‚¤ãƒˆã§ã¯ã€ã€ŒPokÃ©mon Game Sound Libraryã€ã®åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ãŸã†ãˆã§ã€å½“ã‚µã‚¤ãƒˆã§é…å¸ƒã•ã‚ŒãŸéŸ³æºã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
			<p>å½“ã‚µã‚¤ãƒˆã¯å€‹äººãŒé‹å–¶ã™ã‚‹ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆã§ã‚ã‚Šã€æ ªå¼ä¼šç¤¾ãƒã‚±ãƒ¢ãƒ³æ§˜ã‚’å§‹ã‚ã¨ã—ãŸå…¬å¼å›£ä½“ã¨ã¯ä¸€åˆ‡é–¢ä¿‚ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
		</div>
	</div>
</pb-modal>

<pb-modal [isOpen]="isSettingsOpen()" title="Settings" [showFooter]="true" (close)="cancelSettings()">
	<div class="modal-content">
		<h3 class="settings-section-title">Difficulty</h3>
		<div class="settings-options">
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'easy'"
				(click)="tempDifficulty.set('easy')">
				<div>
					<div class="difficulty-title">EASY</div>
					<div class="difficulty-desc">Shows exact multipliers (x4, x2). Best for learning.</div>
				</div>
			</button>
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'normal'"
				(click)="tempDifficulty.set('normal')">
				<div>
					<div class="difficulty-title">NORMAL</div>
					<div class="difficulty-desc">Standard rules. Hides multipliers. 10 Turns.</div>
				</div>
			</button>
			<button class="difficulty-card" [class.selected]="tempDifficulty() === 'master'"
				(click)="tempDifficulty.set('master')">
				<div>
					<div class="difficulty-title">MASTER</div>
					<div class="difficulty-desc">Hardcore. 6 Turns. One-Shot Answer only.</div>
				</div>
			</button>
		</div>
	</div>

	<div footer class="modal-footer">
		<button pb-button color="secondary" pattern="filled" (click)="cancelSettings()">Cancel</button>
		<button pb-button color="primary" pattern="filled" (click)="applySettings()">Apply</button>
	</div>
</pb-modal>

<!-- Result Modal -->
<pb-modal [isOpen]="isGameOver()" [title]="gameResult() === 'win' ? 'WINNER!' : 'GAME OVER'" [showHeader]="false"
	(close)="startGame()">
	<div class="result-content">
		<!-- Header -->
		<div class="result-header" [class.win]="gameResult() === 'win'" [class.lose]="gameResult() === 'lose'">
			<div class="result-emoji">
				{{ gameResult() === 'win' ? 'ğŸ‰' : 'ğŸ’€' }}
			</div>
			<h2 class="result-title" [class.win]="gameResult() === 'win'" [class.lose]="gameResult() === 'lose'">
				{{ gameResult() === 'win' ? 'YOU WIN!' : 'GAME OVER' }}
			</h2>
			<p class="result-subtitle">
				{{ gameResult() === 'win' ? 'Target Captured!' : 'Target Escaped...' }}
			</p>
		</div>

		<!-- Result Details -->
		<div class="result-details">
			<p class="result-label">TARGET WAS</p>
			<div class="result-chips">
				@for (t of target; track t) {
				<pb-label-chip [type]="t" [label]="typeLabels[t]" size="m"></pb-label-chip>
				}
			</div>
		</div>

		<!-- Actions -->
		<div class="result-actions">
			<button pb-button color="primary" pattern="filled" class="result-btn result-btn-primary"
				(click)="startGame()">
				PLAY AGAIN
			</button>
			<button pb-button color="secondary" pattern="outline" class="result-btn result-btn-secondary"
				(click)="shareResult()">
				<pb-icon name="file-copy" size="sm"></pb-icon>
				<span>Share Result</span>
			</button>
		</div>
	</div>

	<!-- Toast Notification (Moved inside modal to appear on top layer, using overlay slot to avoid transform context) -->
	@if (toastMessage()) {
	<pb-toast overlay [type]="toastType()" [message]="toastMessage()!" [duration]="3000" [dismissible]="false"
		(dismiss)="toastMessage.set(null)"></pb-toast>
	}
</pb-modal>