name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-pr:
    name: Validate PR Compliance
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate PR Title
        id: validate-title
        continue-on-error: true
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[a-z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with a lowercase letter.

      - name: Validate Branch Name
        id: validate-branch
        continue-on-error: true
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Validating branch name: $BRANCH_NAME"
          
          # Skip validation for Dependabot branches
          if [[ "$BRANCH_NAME" =~ ^dependabot/ ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=Skipped validation for Dependabot branch" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if branch name follows the pattern: <type>/<description>
          if [[ ! "$BRANCH_NAME" =~ ^(feat|fix|hotfix|refactor|docs|test|chore|style|perf|ci|build|revert)/[a-z0-9-]+$ ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=Branch name '$BRANCH_NAME' does not follow the naming convention '<type>/<description>' or contains invalid characters." >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=Branch name is valid." >> $GITHUB_OUTPUT

      - name: Validate PR Body (Template Usage)
        id: validate-body
        continue-on-error: true
        run: |
          # Store body in a file to avoid shell interpretation issues
          cat > pr_body.txt << 'EOF'
          ${{ github.event.pull_request.body }}
          EOF
          
          BODY=$(cat pr_body.txt)
          MISSING_SECTIONS=""
          
          # Check for key sections from the template
          if [[ "$BODY" != *"## üí° Ê¶ÇË¶Å"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## üí° Ê¶ÇË¶Å\n"; fi
          if [[ "$BODY" != *"## üìù Â§âÊõ¥ÂÜÖÂÆπ"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## üìù Â§âÊõ¥ÂÜÖÂÆπ\n"; fi
          if [[ "$BODY" != *"## üîó Èñ¢ÈÄ£Issue"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## üîó Èñ¢ÈÄ£Issue\n"; fi
          if [[ "$BODY" != *"## ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## ‚úÖ „ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà\n"; fi
          if [[ "$BODY" != *"ÔøΩ PR„Çø„Ç§„Éà„É´„ÅÆÂëΩÂêçË¶èÂâá"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- üìù PR„Çø„Ç§„Éà„É´„ÅÆÂëΩÂêçË¶èÂâá\n"; fi
          if [[ "$BODY" != *"## üìñ „É¨„Éì„É•„ÉºÁî®Ë™ûÈõÜ"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## üìñ „É¨„Éì„É•„ÉºÁî®Ë™ûÈõÜ\n"; fi
          if [[ "$BODY" != *"## üìå Ë£úË∂≥‰∫ãÈ†Ö"* ]]; then MISSING_SECTIONS="${MISSING_SECTIONS}- ## üìå Ë£úË∂≥‰∫ãÈ†Ö\n"; fi
          
          if [[ -n "$MISSING_SECTIONS" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=PR description is missing the following required sections:\n$MISSING_SECTIONS" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=PR description looks valid." >> $GITHUB_OUTPUT
      
      - name: Report Validation Status
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const titleStatus = '${{ steps.validate-title.outcome }}';
            const branchStatus = '${{ steps.validate-branch.outputs.status }}' || ( '${{ steps.validate-branch.outcome }}' === 'success' ? 'success' : 'failure' );
            const bodyStatus = '${{ steps.validate-body.outputs.status }}' || ( '${{ steps.validate-body.outcome }}' === 'success' ? 'success' : 'failure' );
            
            const branchMsg = '${{ steps.validate-branch.outputs.message }}' || 'Branch naming validation failed.';
            const bodyMsg = '${{ steps.validate-body.outputs.message }}' || 'Template usage validation failed.';

            // If all checks passed, do nothing (or could verify removal of previous error comments)
            if (titleStatus === 'success' && branchStatus === 'success' && bodyStatus === 'success') {
              console.log('All validations passed!');
              return;
            }

            let commentBody = '## ‚ö†Ô∏è PR Validation Failed\n\nPlease address the following issues:\n\n';

            if (titleStatus !== 'success') {
              commentBody += '### üö´ Invalid PR Title\n';
              commentBody += 'The PR title must follow Conventional Commits (e.g., `feat: add new feature`).\n';
              commentBody += '- **Format**: `<type>: <description>`\n';
              commentBody += '- **Types**: `feat`, `fix`, `docs`, `style`, `refactor`, `perf`, `test`, `build`, `ci`, `chore`, `revert`\n';
              commentBody += '- **Description**: Start with a lowercase letter.\n\n';
            }

            if (branchStatus !== 'success') {
              commentBody += '### üö´ Invalid Branch Name\n';
              commentBody += branchMsg + '\n';
              commentBody += '- **Format**: `<type>/<description>`\n';
              commentBody += '- **Example**: `feat/user-login`, `fix/header-layout`\n\n';
            }

            if (bodyStatus !== 'success') {
              commentBody += '### üö´ Incomplete PR Description\n';
              commentBody += bodyMsg.replace(/\\n/g, '\n') + '\n';
              commentBody += 'Please ensure you are using the [PULL_REQUEST_TEMPLATE](https://github.com/${{ github.repository }}/blob/main/.github/PULL_REQUEST_TEMPLATE.md).\n\n';
            }

            commentBody += '---\nRead [CONTRIBUTING.md](https://github.com/${{ github.repository }}/blob/main/CONTRIBUTING.md) for more details.';

            // Post the comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Fail the workflow if any check failed
            core.setFailed('One or more PR validation checks failed.');
